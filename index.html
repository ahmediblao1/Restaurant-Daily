<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Daily Accounting System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .date-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        .date-selector input {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .section h2 {
            color: #34495e;
            margin-top: 0;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        .platform-row {
            background-color: #ecf0f1;
        }
        .total-row {
            background-color: #f39c12;
            color: white;
            font-weight: bold;
        }
        .input-field {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        .summary {
            background-color: #2ecc71;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        .summary h3 {
            margin-top: 0;
            font-size: 24px;
            margin-bottom: 20px;
        }
        .summary p {
            font-size: 18px;
            margin: 10px 0;
        }
        .summary .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .summary .summary-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }
        .btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .export-btn {
            background-color: #27ae60;
        }
        .export-btn:hover {
            background-color: #229954;
        }
        .commission-rate {
            color: #e74c3c;
            font-weight: bold;
        }
        .net-amount {
            color: #27ae60;
            font-weight: bold;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .notification.success {
            background-color: #27ae60;
        }
        .notification.error {
            background-color: #e74c3c;
        }
        .notification.show {
            opacity: 1;
        }
        .reports-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .saved-reports {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .report-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .report-item button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .report-item button:hover {
            background-color: #c0392b;
        }

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons inside the tab */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 data-translate="title">üìä Restaurant Daily Accounting System</h1>
        
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'daily-entry')" data-translate="dailyEntry">Daily Entry</button>
            <button class="tablinks" onclick="openTab(event, 'inventory')" data-translate="inventory">Inventory</button>
            <button class="tablinks" onclick="openTab(event, 'expenses')" data-translate="expenses">Expenses</button>
            <button class="tablinks" onclick="openTab(event, 'reports')" data-translate="reports">Reports</button>
            <button class="tablinks" onclick="openTab(event, 'history')" data-translate="history">History</button>
        </div>

        <div id="daily-entry" class="tabcontent">
            <div class="date-selector">
            <label for="report-date" data-translate="reportDate">Report Date: </label>
            <input type="date" id="report-date" value="">
            <select id="language-selector" onchange="changeLanguage()" style="padding: 8px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; margin-left: 10px;">
                <option value="en">English</option>
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
        </div>

        <!-- Sales Section -->
        <div class="section">
            <h2 data-translate="dailySales">üí∞ Daily Sales Report</h2>
            <div style="margin-bottom: 15px;">
                <label for="trendyol-file">Trendyol:</label>
                <input type="file" id="trendyol-file" onchange="handleFileUpload(event, 'trendyol')">
                <label for="yemeksepeti-file">Yemeksepeti:</label>
                <input type="file" id="yemeksepeti-file" onchange="handleFileUpload(event, 'yemeksepeti')">
                <label for="in-store-file">In-Store:</label>
                <input type="file" id="in-store-file" onchange="handleFileUpload(event, 'in-store')">
            </div>
            <table>
                <thead>
                    <tr>
                        <th data-translate="platform">Platform</th>
                        <th data-translate="grossSales">Gross Sales (TRY)</th>
                        <th data-translate="commissionRate">Commission Rate (%)</th>
                        <th data-translate="commissionAmount">Commission Amount (TRY)</th>
                        <th data-translate="discountReturns">Discount/Returns (TRY)</th>
                        <th data-translate="netSales">Net Sales (TRY)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="platform-row">
                        <td><strong data-translate="trendyol">Trendyol</strong></td>
                        <td><input type="number" class="input-field" id="trendyol-gross" placeholder="16,575" oninput="calculateSales()"></td>
                        <td><span class="commission-rate">36.6%</span></td>
                        <td><span id="trendyol-commission">0.00</span></td>
                        <td><input type="number" class="input-field" id="trendyol-discount" placeholder="270" oninput="calculateSales()"></td>
                        <td><span id="trendyol-net" class="net-amount">0.00</span></td>
                    </tr>
                    <tr class="platform-row">
                        <td><strong data-translate="yemeksepeti">Yemeksepeti</strong></td>
                        <td><input type="number" class="input-field" id="yemeksepeti-gross" placeholder="3,285" oninput="calculateSales()"></td>
                        <td><span class="commission-rate">38.4%</span></td>
                        <td><span id="yemeksepeti-commission">0.00</span></td>
                        <td><input type="number" class="input-field" id="yemeksepeti-discount" placeholder="980" oninput="calculateSales()"></td>
                        <td><span id="yemeksepeti-net" class="net-amount">0.00</span></td>
                    </tr>
                    <tr class="platform-row">
                        <td><strong data-translate="inStoreSalesCash">In-Store (Cash)</strong></td>
                        <td><input type="number" class="input-field" id="store-cash-gross" placeholder="4,000" oninput="calculateSales()"></td>
                        <td><span class="commission-rate">0%</span></td>
                        <td><span id="store-cash-commission">0.00</span></td>
                        <td><input type="number" class="input-field" id="store-cash-discount" placeholder="20" oninput="calculateSales()"></td>
                        <td><span id="store-cash-net" class="net-amount">0.00</span></td>
                    </tr>
                    <tr class="platform-row">
                        <td><strong data-translate="inStoreSalesCard">In-Store (Credit Card)</strong></td>
                        <td><input type="number" class="input-field" id="store-card-gross" placeholder="2,675" oninput="calculateSales()"></td>
                        <td><span class="commission-rate">0%</span></td>
                        <td><span id="store-card-commission">0.00</span></td>
                        <td><input type="number" class="input-field" id="store-card-discount" placeholder="27" oninput="calculateSales()"></td>
                        <td><span id="store-card-net" class="net-amount">0.00</span></td>
                    </tr>
                    <tr class="total-row">
                        <td><strong data-translate="total">TOTAL</strong></td>
                        <td><strong><span id="total-gross">0.00</span></strong></td>
                        <td>-</td>
                        <td><strong><span id="total-commission">0.00</span></strong></td>
                        <td><strong><span id="total-discount">0.00</span></strong></td>
                        <td><strong><span id="total-net">0.00</span></strong></td>
                    </tr>
                    <tr>
                        <td colspan="4" data-translate="complimentary">Complimentary</td>
                        <td><input type="number" class="input-field" id="complimentary"></td>
                        <td><input type="text" class="input-field" id="complimentary-notes" placeholder="Notes"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Expenses Section -->
        <div class="section">
            <h2 data-translate="dailyExpenses">üí∏ Daily Expenses</h2>
            <table>
                <thead>
                    <tr>
                        <th data-translate="expenseCategory">Expense Category</th>
                        <th data-translate="amount">Amount (TRY)</th>
                        <th data-translate="notes">Notes</th>
                    </tr>
                </thead>
                <tbody id="expenses-tbody">
                    <!-- Expense rows will be added here dynamically -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2"><strong data-translate="totalExpenses">TOTAL EXPENSES</strong></td>
                        <td><strong><span id="total-expenses">0.00</span></strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <button class="btn" onclick="addExpenseRow()" data-translate="addExpense">+ Add Expense</button>
            </table>
        </div>

        <!-- Daily Summary -->
        <div class="summary" id="summary-section">
            <h3 data-translate="dailySummary">üìà Daily Summary <span id="summary-date" style="font-size: 16px; font-weight: normal;"></span></h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <p><strong data-translate="totalGrossSales">Total Gross Sales:</strong> <span id="summary-gross">0.00</span> TRY</p>
                    <p><strong data-translate="totalCommissionPaid">Total Commission Paid:</strong> <span id="summary-commission">0.00</span> TRY</p>
                    <p><strong data-translate="totalNetSales">Total Net Sales:</strong> <span id="summary-net">0.00</span> TRY</p>
                </div>
                <div class="summary-item">
                    <p><strong data-translate="totalExpensesLabel">Total Expenses:</strong> <span id="summary-expenses">0.00</span> TRY</p>
                    <p><strong data-translate="netProfit">Net Profit:</strong> <span id="summary-profit">0.00</span> TRY</p>
                    <p><strong data-translate="profitMargin">Profit Margin:</strong> <span id="summary-margin">0.0</span>%</p>
                </div>
                <div class="summary-item">
                    <p><strong data-translate="cashInStore">Cash in Store:</strong> <input type="number" class="input-field" id="cash-in-store"></p>
                    <p><strong data-translate="cashWithAbdelhamid">Cash with Abdelhamid:</strong> <input type="number" class="input-field" id="cash-with-abdelhamid"></p>
                </div>
                <div class="summary-item">
                    <p><strong data-translate="complimentary">Complimentary:</strong> <span id="summary-complimentary">0.00</span> TRY</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="exportSummary('png')">Export as Image</button>
                <button class="btn" onclick="exportSummary('pdf')">Export as PDF</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="saveReport()" data-translate="saveReport">üíæ Save Report</button>
            <button class="btn export-btn" onclick="exportToExcel()" data-translate="exportToExcel">üìä Export to Excel</button>
            <button class="btn" onclick="clearAll()" data-translate="clearAll">üóëÔ∏è Clear All</button>
            <button class="btn" onclick="loadSampleData()" data-translate="loadSampleData">üìã Load Sample Data</button>
        </div>

        <!-- Saved Reports Section -->
        <div class="reports-section">
            <h2 data-translate="savedReports">üìÅ Saved Reports</h2>
            <div class="saved-reports" id="saved-reports-list">
                <p data-translate="noSavedReports">No saved reports yet.</p>
            </div>
        </div>

        <!-- Monthly Report Section -->
        <div class="reports-section">
            <h2 data-translate="monthlyReport">üìÖ Monthly Report</h2>
            <div style="margin-bottom: 15px;">
                <label for="month-selector" data-translate="selectMonth">Select Month:</label>
                <input type="month" id="month-selector" style="padding: 8px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px;">
                <button class="btn" onclick="generateMonthlyReport()" data-translate="generateReport">Generate Report</button>
            </div>
            <div id="monthly-report-container" style="display: none;">
                <h3 id="monthly-report-title"></h3>
                <table id="monthly-report-table">
                    <!-- Monthly report data will be displayed here -->
                </table>
            </div>
        </div>

        <!-- Inventory Section -->
        <div class="section">
            <h2 data-translate="inventory">üì¶ Inventory</h2>
            <table>
                <thead>
                    <tr>
                        <th data-translate="itemName">Item Name</th>
                        <th data-translate="quantity">Quantity</th>
                        <th data-translate="unit">Unit</th>
                        <th data-translate="costPerUnit">Cost per Unit</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="inventory-tbody">
                    <!-- Inventory items will be added here dynamically -->
                </tbody>
            </table>
            <button class="btn" onclick="addInventoryItem()" data-translate="addItem">+ Add Item</button>
        </div>
        </div>

        <div id="reports" class="tabcontent">
            <h2 data-translate="reports">Reports</h2>
            <div id="reports-content">
                </div>
        </div>

        <div id="history" class="tabcontent">
            <h2 data-translate="history">History</h2>
            <div id="history-content">
                </div>
        </div>

        <div id="inventory" class="tabcontent">
            <h2 data-translate="inventory">Inventory</h2>
            <div id="inventory-content">
            </div>
        </div>

        <div id="expenses" class="tabcontent">
            <h2 data-translate="expenses">Expenses</h2>
            <div id="expenses-content">
                </div>
        </div>

    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // In-memory storage for reports
        let savedReports = [];
        let expenses = [];
        let inventory = [];

        // Set today's date on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('report-date').value = new Date().toISOString().split('T')[0];
            const storedReports = localStorage.getItem('savedReports');
            if (storedReports) {
                savedReports = JSON.parse(storedReports);
            }
            const storedExpenses = localStorage.getItem('expenses');
            if (storedExpenses) {
                expenses = JSON.parse(storedExpenses);
            }
            const storedInventory = localStorage.getItem('inventory');
            if (storedInventory) {
                inventory = JSON.parse(storedInventory);
            }
            addExpenseRow(); // Add an initial expense row
            updateSavedReportsList();
            loadInventory();
            changeLanguage(); // Set initial language
        });

        const translations = {
            en: {
                title: "üìä Restaurant Daily Accounting System",
                reportDate: "Report Date:",
                dailySales: "üí∞ Daily Sales Report",
                expenses: "Expenses",
                platform: "Platform",
                grossSales: "Gross Sales (TRY)",
                commissionRate: "Commission Rate (%)",
                commissionAmount: "Commission Amount (TRY)",
                discountReturns: "Discount/Returns (TRY)",
                netSales: "Net Sales (TRY)",
                trendyol: "Trendyol",
                yemeksepeti: "Yemeksepeti",
                inStoreSalesCash: "In-Store (Cash)",
                inStoreSalesCard: "In-Store (Credit Card)",
                total: "TOTAL",
                dailyExpenses: "üí∏ Daily Expenses",
                expenseCategory: "Expense Category",
                amount: "Amount (TRY)",
                notes: "Notes",
                foodIngredients: "Food & Ingredients",
                staffSalaries: "Staff Salaries",
                utilities: "Utilities",
                deliveryCosts: "Delivery Costs",
                otherExpenses: "Other Expenses",
                advertising: "Advertising",
                totalExpenses: "TOTAL EXPENSES",
                addExpense: "+ Add Expense",
                dailySummary: "üìà Daily Summary",
                totalGrossSales: "Total Gross Sales:",
                totalCommissionPaid: "Total Commission Paid:",
                totalNetSales: "Total Net Sales:",
                totalExpensesLabel: "Total Expenses:",
                netProfit: "Net Profit:",
                profitMargin: "Profit Margin:",
                saveReport: "üíæ Save Report",
                exportToExcel: "üìä Export to Excel",
                clearAll: "üóëÔ∏è Clear All",
                loadSampleData: "üìã Load Sample Data",
                savedReports: "üìÅ Saved Reports",
                noSavedReports: "No saved reports yet.",
                monthlyReport: "üìÖ Monthly Report",
                selectMonth: "Select Month:",
                generateReport: "Generate Report",
                inventory: "üì¶ Inventory",
                itemName: "Item Name",
                quantity: "Quantity",
                unit: "Unit",
                costPerUnit: "Cost per Unit",
                addItem: "+ Add Item",
                inventoryValue: "Inventory Value",
                cashInStore: "Cash in Store",
                cashWithAbdelhamid: "Cash with Abdelhamid",
                complimentary: "Complimentary",
                productSales: "üìà Product Sales",
                productName: "Product Name",
                dailyEntry: "Daily Entry",
                reports: "Reports",
                history: "History",
                confirmClear: "Are you sure you want to clear all data?",
                confirmDelete: "Are you sure you want to delete this report?",
                notifications: {
                    reportSaved: "Report saved successfully!",
                    reportUpdated: "Report updated successfully!",
                    reportExported: "Report exported successfully!",
                    allDataCleared: "All data cleared!",
                    sampleDataLoaded: "Sample data loaded!",
                    reportLoaded: "Report loaded successfully!",
                    reportDeleted: "Report deleted!",
                }
            },
            ar: {
                title: "üìä ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑŸäŸàŸÖŸäÿ© ŸÑŸÑŸÖÿ∑ÿßÿπŸÖ",
                reportDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±:",
                dailySales: "üí∞ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸäŸàŸÖŸä",
                expenses: "ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ",
                platform: "ÿßŸÑŸÖŸÜÿµÿ©",
                grossSales: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ (ŸÑŸäÿ±ÿ© ÿ™ÿ±ŸÉŸäÿ©)",
                commissionRate: "ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿπŸÖŸàŸÑÿ© (%)",
                commissionAmount: "ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπŸÖŸàŸÑÿ© (ŸÑŸäÿ±ÿ© ÿ™ÿ±ŸÉŸäÿ©)",
                discountReturns: "ÿßŸÑÿÆÿµŸàŸÖÿßÿ™/ÿßŸÑŸÖÿ±ÿ™ÿ¨ÿπÿßÿ™ (ŸÑŸäÿ±ÿ© ÿ™ÿ±ŸÉŸäÿ©)",
                netSales: "ÿµÿßŸÅŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ (ŸÑŸäÿ±ÿ© ÿ™ÿ±ŸÉŸäÿ©)",
                trendyol: "ÿ™ÿ±ŸäŸÜÿØŸäŸàŸÑ",
                yemeksepeti: "ŸäŸÖŸÉ ÿ≥Ÿäÿ®Ÿäÿ™Ÿä",
                inStoreSalesCash: "ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ™ÿ¨ÿ± (ŸÜŸÇÿØÿßŸã)",
                inStoreSalesCard: "ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ™ÿ¨ÿ± (ÿ®ÿ∑ÿßŸÇÿ© ÿßÿ¶ÿ™ŸÖÿßŸÜ)",
                total: "ÿßŸÑŸÖÿ¨ŸÖŸàÿπ",
                dailyExpenses: "üí∏ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑŸäŸàŸÖŸäÿ©",
                expenseCategory: "ŸÅÿ¶ÿ© ÿßŸÑŸÖÿµÿ±ŸàŸÅ",
                amount: "ÿßŸÑŸÖÿ®ŸÑÿ∫ (ŸÑŸäÿ±ÿ© ÿ™ÿ±ŸÉŸäÿ©)",
                notes: "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™",
                foodIngredients: "ÿßŸÑÿ∑ÿπÿßŸÖ ŸàÿßŸÑŸÖŸÉŸàŸÜÿßÿ™",
                staffSalaries: "ÿ±Ÿàÿßÿ™ÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ",
                utilities: "ÿÆÿØŸÖÿßÿ™",
                deliveryCosts: "ÿ™ŸÉÿßŸÑŸäŸÅ ÿßŸÑÿ™ŸàÿµŸäŸÑ",
                otherExpenses: "ŸÖÿµÿßÿ±ŸäŸÅ ÿ£ÿÆÿ±Ÿâ",
                advertising: "ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™",
                totalExpenses: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ",
                addExpense: "+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ",
                dailySummary: "üìà ŸÖŸÑÿÆÿµ ÿßŸÑŸäŸàŸÖ",
                totalGrossSales: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™:",
                totalCommissionPaid: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπŸÖŸàŸÑÿ© ÿßŸÑŸÖÿØŸÅŸàÿπÿ©:",
                totalNetSales: "ÿµÿßŸÅŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™:",
                totalExpensesLabel: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ:",
                netProfit: "ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠:",
                profitMargin: "ŸáÿßŸÖÿ¥ ÿßŸÑÿ±ÿ®ÿ≠:",
                saveReport: "üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±",
                exportToExcel: "üìä ÿ™ÿµÿØŸäÿ± ÿ•ŸÑŸâ Excel",
                clearAll: "üóëÔ∏è ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ",
                loadSampleData: "üìã ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©",
                savedReports: "üìÅ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©",
                noSavedReports: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇÿßÿ±Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ.",
                monthlyReport: "üìÖ ÿ™ŸÇÿ±Ÿäÿ± ÿ¥Ÿáÿ±Ÿä",
                selectMonth: "ÿßÿÆÿ™ÿ± ÿßŸÑÿ¥Ÿáÿ±:",
                generateReport: "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±",
                inventory: "üì¶ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ",
                itemName: "ÿßÿ≥ŸÖ ÿßŸÑÿπŸÜÿµÿ±",
                quantity: "ÿßŸÑŸÉŸÖŸäÿ©",
                unit: "ÿßŸÑŸàÿ≠ÿØÿ©",
                costPerUnit: "ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ŸÑŸÉŸÑ Ÿàÿ≠ÿØÿ©",
                addItem: "+ ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÜÿµÿ±",
                inventoryValue: "ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ",
                cashInStore: "ÿßŸÑŸÜŸÇÿØ ŸÅŸä ÿßŸÑŸÖÿ™ÿ¨ÿ±",
                cashWithAbdelhamid: "ÿßŸÑŸÜŸÇÿØ ŸÖÿπ ÿπÿ®ÿØ ÿßŸÑÿ≠ŸÖŸäÿØ",
                complimentary: "ŸÖÿ¨ÿßŸÜŸä",
                productSales: "üìà ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™",
                productName: "ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨",
                dailyEntry: "ÿ•ÿØÿÆÿßŸÑ ŸäŸàŸÖŸä",
                reports: "ÿ™ŸÇÿßÿ±Ÿäÿ±",
                history: "ÿ≥ÿ¨ŸÑ",
                confirmClear: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü",
                confirmDelete: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±ÿü",
                notifications: {
                    reportSaved: "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!",
                    reportUpdated: "ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!",
                    reportExported: "ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!",
                    allDataCleared: "ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™!",
                    sampleDataLoaded: "ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©!",
                    reportLoaded: "ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!",
                    reportDeleted: "ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±!",
                }
            }
        };

        function changeLanguage() {
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });

            // Update direction for Arabic
            if (lang === 'ar') {
                document.body.style.direction = 'rtl';
                document.body.style.textAlign = 'right';
                document.querySelectorAll('th, td').forEach(el => el.style.textAlign = 'right');
            } else {
                document.body.style.direction = 'ltr';
                document.body.style.textAlign = 'left';
                document.querySelectorAll('th, td').forEach(el => el.style.textAlign = 'left');
            }
        }

        function calculateSales() {
            // Trendyol calculations
            const trendyolGross = parseFloat(document.getElementById('trendyol-gross').value) || 0;
            const trendyolDiscount = parseFloat(document.getElementById('trendyol-discount').value) || 0;
            const trendyolCommission = trendyolGross * 0.366; // 36.6% commission
            const trendyolNet = trendyolGross - trendyolCommission - trendyolDiscount;
            
            document.getElementById('trendyol-commission').textContent = trendyolCommission.toFixed(2);
            document.getElementById('trendyol-net').textContent = trendyolNet.toFixed(2);

            // Yemeksepeti calculations
            const yemeksepetiGross = parseFloat(document.getElementById('yemeksepeti-gross').value) || 0;
            const yemeksepetiDiscount = parseFloat(document.getElementById('yemeksepeti-discount').value) || 0;
            const yemeksepetiCommission = yemeksepetiGross * 0.384; // 38.4% commission
            const yemeksepetiNet = yemeksepetiGross - yemeksepetiCommission - yemeksepetiDiscount;
            
            document.getElementById('yemeksepeti-commission').textContent = yemeksepetiCommission.toFixed(2);
            document.getElementById('yemeksepeti-net').textContent = yemeksepetiNet.toFixed(2);

            // Store (Cash) calculations
            const storeCashGross = parseFloat(document.getElementById('store-cash-gross').value) || 0;
            const storeCashDiscount = parseFloat(document.getElementById('store-cash-discount').value) || 0;
            const storeCashCommission = 0;
            const storeCashNet = storeCashGross - storeCashDiscount;

            document.getElementById('store-cash-commission').textContent = storeCashCommission.toFixed(2);
            document.getElementById('store-cash-net').textContent = storeCashNet.toFixed(2);

            // Store (Credit Card) calculations
            const storeCardGross = parseFloat(document.getElementById('store-card-gross').value) || 0;
            const storeCardDiscount = parseFloat(document.getElementById('store-card-discount').value) || 0;
            const storeCardCommission = 0;
            const storeCardNet = storeCardGross - storeCardDiscount;

            document.getElementById('store-card-commission').textContent = storeCardCommission.toFixed(2);
            document.getElementById('store-card-net').textContent = storeCardNet.toFixed(2);

            // Totals
            const totalGross = trendyolGross + yemeksepetiGross + storeCashGross + storeCardGross;
            const totalCommission = trendyolCommission + yemeksepetiCommission + storeCashCommission + storeCardCommission;
            const totalDiscount = trendyolDiscount + yemeksepetiDiscount + storeCashDiscount + storeCardDiscount;
            const totalNet = trendyolNet + yemeksepetiNet + storeCashNet + storeCardNet;

            document.getElementById('total-gross').textContent = totalGross.toFixed(2);
            document.getElementById('total-commission').textContent = totalCommission.toFixed(2);
            document.getElementById('total-discount').textContent = totalDiscount.toFixed(2);
            document.getElementById('total-net').textContent = totalNet.toFixed(2);

            updateSummary();
        }

        function addExpenseRow() {
            const tbody = document.getElementById('expenses-tbody');
            const newRow = document.createElement('tr');
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            const categories = [
                t.foodIngredients,
                t.staffSalaries,
                t.utilities,
                t.deliveryCosts,
                t.otherExpenses,
                t.advertising
            ];

            const options = categories.map(category => `<option value="${category}">${category}</option>`).join('');

            newRow.innerHTML = `
                <td>
                    <select class="input-field expense-category">
                        ${options}
                    </select>
                </td>
                <td><input type="number" class="input-field expense-amount" oninput="calculateExpenses()"></td>
                <td><input type="text" class="input-field expense-notes" placeholder="Notes"></td>
                <td><button class="btn" onclick="removeExpenseRow(this)">-</button></td>
            `;
            tbody.appendChild(newRow);
            changeLanguage();
        }

        function removeExpenseRow(button) {
            button.closest('tr').remove();
            calculateExpenses();
        }

        function calculateExpenses() {
            let totalExpenses = 0;
            document.querySelectorAll('#expenses-tbody tr').forEach(row => {
                const amount = parseFloat(row.querySelector('.expense-amount').value) || 0;
                totalExpenses += amount;
            });
            
            document.getElementById('total-expenses').textContent = totalExpenses.toFixed(2);
            updateSummary();
        }

        function updateSummary() {
            const totalGross = parseFloat(document.getElementById('total-gross').textContent) || 0;
            const totalCommission = parseFloat(document.getElementById('total-commission').textContent) || 0;
            const totalNet = parseFloat(document.getElementById('total-net').textContent) || 0;
            const totalExpenses = parseFloat(document.getElementById('total-expenses').textContent) || 0;
            const complimentary = parseFloat(document.getElementById('complimentary').value) || 0;
            
            const netProfit = totalNet - totalExpenses;
            const profitMargin = totalNet > 0 ? (netProfit / totalNet * 100) : 0;
            
            document.getElementById('summary-gross').textContent = totalGross.toFixed(2);
            document.getElementById('summary-commission').textContent = totalCommission.toFixed(2);
            document.getElementById('summary-net').textContent = totalNet.toFixed(2);
            document.getElementById('summary-expenses').textContent = totalExpenses.toFixed(2);
            document.getElementById('summary-profit').textContent = netProfit.toFixed(2);
            document.getElementById('summary-margin').textContent = profitMargin.toFixed(1);
            document.getElementById('summary-complimentary').textContent = complimentary.toFixed(2);
            document.getElementById('summary-date').textContent = document.getElementById('report-date').value;
        }

        function saveReport() {
            const reportData = {
                date: document.getElementById('report-date').value,
                timestamp: new Date().toISOString(),
                sales: {
                    trendyol: {
                        gross: document.getElementById('trendyol-gross').value || '0',
                        discount: document.getElementById('trendyol-discount').value || '0',
                        commission: document.getElementById('trendyol-commission').textContent,
                        net: document.getElementById('trendyol-net').textContent
                    },
                    yemeksepeti: {
                        gross: document.getElementById('yemeksepeti-gross').value || '0',
                        discount: document.getElementById('yemeksepeti-discount').value || '0',
                        commission: document.getElementById('yemeksepeti-commission').textContent,
                        net: document.getElementById('yemeksepeti-net').textContent
                    },
                    storeCash: {
                        gross: document.getElementById('store-cash-gross').value || '0',
                        discount: document.getElementById('store-cash-discount').value || '0',
                        net: document.getElementById('store-cash-net').textContent
                    },
                    storeCard: {
                        gross: document.getElementById('store-card-gross').value || '0',
                        discount: document.getElementById('store-card-discount').value || '0',
                        net: document.getElementById('store-card-net').textContent
                    },
                    complimentary: document.getElementById('complimentary').value || '0',
                    complimentaryNotes: document.getElementById('complimentary-notes').value || ''
                },
                expenses: Array.from(document.querySelectorAll('#expenses-tbody tr')).map(row => ({
                    category: row.querySelector('.expense-category').value,
                    amount: row.querySelector('.expense-amount').value,
                    notes: row.querySelector('.expense-notes').value
                })),
                summary: {
                    totalGross: document.getElementById('summary-gross').textContent,
                    totalNet: document.getElementById('summary-net').textContent,
                    totalExpenses: document.getElementById('summary-expenses').textContent,
                    netProfit: document.getElementById('summary-profit').textContent,
                    profitMargin: document.getElementById('summary-margin').textContent,
                    cashInStore: document.getElementById('cash-in-store').value,
                    cashWithAbdelhamid: document.getElementById('cash-with-abdelhamid').value
                }
            };
            
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            // Check if report for this date already exists
            const existingIndex = savedReports.findIndex(report => report.date === reportData.date);
            if (existingIndex !== -1) {
                savedReports[existingIndex] = reportData;
                showNotification(t.notifications.reportUpdated, 'success');
            } else {
                savedReports.push(reportData);
                showNotification(t.notifications.reportSaved, 'success');
            }

            localStorage.setItem('savedReports', JSON.stringify(savedReports));
            updateSavedReportsList();
        }

        function exportToExcel() {
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];
            const date = document.getElementById('report-date').value;

            const wb = XLSX.utils.book_new();
            const ws_name = "Daily Report";

            // --- Data ---
            let data = [
                [t.dailySales],
                [t.platform, t.grossSales, t.commissionRate, t.commissionAmount, t.discountReturns, t.netSales],
                [t.trendyol, document.getElementById('trendyol-gross').value, '36.6%', document.getElementById('trendyol-commission').textContent, document.getElementById('trendyol-discount').value, document.getElementById('trendyol-net').textContent],
                [t.yemeksepeti, document.getElementById('yemeksepeti-gross').value, '38.4%', document.getElementById('yemeksepeti-commission').textContent, document.getElementById('yemeksepeti-discount').value, document.getElementById('yemeksepeti-net').textContent],
                [t.inStoreSalesCash, document.getElementById('store-cash-gross').value, '0%', document.getElementById('store-cash-commission').textContent, document.getElementById('store-cash-discount').value, document.getElementById('store-cash-net').textContent],
                [t.inStoreSalesCard, document.getElementById('store-card-gross').value, '0%', document.getElementById('store-card-commission').textContent, document.getElementById('store-card-discount').value, document.getElementById('store-card-net').textContent],
                [t.total, document.getElementById('total-gross').textContent, '', document.getElementById('total-commission').textContent, document.getElementById('total-discount').textContent, document.getElementById('total-net').textContent],
                [], // Spacer
                [t.dailyExpenses],
                [t.expenseCategory, t.amount, t.notes]
            ];
            document.querySelectorAll('#expenses-tbody tr').forEach(row => {
                data.push([
                    row.querySelector('.expense-category').value,
                    row.querySelector('.expense-amount').value,
                    row.querySelector('.expense-notes').value
                ]);
            });
            data.push([t.totalExpenses, document.getElementById('total-expenses').textContent, '']);
            data.push([]); // Spacer
            data.push([t.dailySummary]);
            data.push([t.totalGrossSales, document.getElementById('summary-gross').textContent]);
            data.push([t.totalCommissionPaid, document.getElementById('summary-commission').textContent]);
            data.push([t.totalNetSales, document.getElementById('summary-net').textContent]);
            data.push([t.totalExpensesLabel, document.getElementById('summary-expenses').textContent]);
            data.push([t.netProfit, document.getElementById('summary-profit').textContent]);
            data.push([t.profitMargin, document.getElementById('summary-margin').textContent + '%']);
            data.push([t.cashInStore, document.getElementById('cash-in-store').value]);
            data.push([t.cashWithAbdelhamid, document.getElementById('cash-with-abdelhamid').value]);
            data.push([t.complimentary, document.getElementById('complimentary').value, document.getElementById('complimentary-notes').value]);

            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, ws_name);

            // --- Styling ---
            const titleStyle = { font: { bold: true, sz: 18, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "2F75B5" } }, alignment: { horizontal: "center", vertical: "center" } };
            const headerStyle = { font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "5A9BD5" } }, alignment: { horizontal: "center" } };
            const totalStyle = { font: { bold: true, sz: 12 }, fill: { fgColor: { rgb: "F2F2F2" } } };
            const summaryLabelStyle = { font: { bold: true } };

            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } },
                { s: { r: 8, c: 0 }, e: { r: 8, c: 2 } },
                { s: { r: data.length - 8, c: 0 }, e: { r: data.length - 8, c: 1 } }
            ];

            ws['A1'].s = titleStyle;
            ws['A9'].s = titleStyle;
            ws['A' + (data.length - 7)].s = titleStyle;

            ['A2', 'B2', 'C2', 'D2', 'E2', 'F2'].forEach(cell => ws[cell].s = headerStyle);
            ['A10', 'B10', 'C10'].forEach(cell => ws[cell].s = headerStyle);
            
            for (let i = 14; i < data.length; i++) {
                if(ws['A' + (i + 1)]) ws['A' + (i + 1)].s = summaryLabelStyle;
            }
            
            if(ws['A7']) ws['A7'].s = totalStyle;
            if(ws['B7']) ws['B7'].s = totalStyle;
            if(ws['D7']) ws['D7'].s = totalStyle;
            if(ws['E7']) ws['E7'].s = totalStyle;
            if(ws['F7']) ws['F7'].s = totalStyle;
            if(ws['A' + (data.length - 2)]) ws['A' + (data.length - 2)].s = totalStyle;
            if(ws['B' + (data.length - 2)]) ws['B' + (data.length - 2)].s = totalStyle;


            ws['!cols'] = [
                { wch: 25 },
                { wch: 15 },
                { wch: 15 },
                { wch: 20 },
                { wch: 20 },
                { wch: 15 }
            ];


            // --- Export ---
            XLSX.writeFile(wb, `daily_report_${date}.xlsx`);
            
            showNotification(t.notifications.reportExported, 'success');
        }

        function clearAll() {
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];
            if (confirm(t.confirmClear)) {
                document.querySelectorAll('.input-field').forEach(input => input.value = '');
                calculateSales();
                calculateExpenses();
                showNotification(t.notifications.allDataCleared, 'success');
            }
        }

        function loadSampleData() {
            // Load sample data for testing
            document.getElementById('trendyol-gross').value = '16575';
            document.getElementById('trendyol-discount').value = '270';
            document.getElementById('yemeksepeti-gross').value = '3285';
            document.getElementById('yemeksepeti-discount').value = '980';
            document.getElementById('store-cash-gross').value = '4000';
            document.getElementById('store-cash-discount').value = '20';
            document.getElementById('store-card-gross').value = '2675';
            document.getElementById('store-card-discount').value = '27';
            document.getElementById('cash-in-store').value = '1000';

            const expensesTbody = document.getElementById('expenses-tbody');
            expensesTbody.innerHTML = ''; // Clear existing rows
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            const sampleExpenses = [
                { category: t.foodIngredients, amount: '8500', notes: 'Fresh ingredients from local suppliers' },
                { category: t.staffSalaries, amount: '2200', notes: 'Daily wages for 6 staff members' },
                { category: t.utilities, amount: '850', notes: 'Electricity and water bills' },
                { category: t.deliveryCosts, amount: '450', notes: 'Fuel and vehicle maintenance' },
                { category: t.otherExpenses, amount: '300', notes: 'Cleaning supplies and marketing' }
            ];

            sampleExpenses.forEach(expense => {
                addExpenseRow();
                const newRow = expensesTbody.lastChild;
                newRow.querySelector('.expense-category').value = expense.category;
                newRow.querySelector('.expense-amount').value = expense.amount;
                newRow.querySelector('.expense-notes').value = expense.notes;
            });
            
            calculateSales();
            calculateExpenses();
            showNotification(t.notifications.sampleDataLoaded, 'success');
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateSavedReportsList() {
            const listContainer = document.getElementById('saved-reports-list');
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];
            
            if (savedReports.length === 0) {
                listContainer.innerHTML = `<p>${t.noSavedReports}</p>`;
                return;
            }
            
            listContainer.innerHTML = savedReports.map((report, index) => `
                <div class="report-item">
                    <div>
                        <strong>${report.date}</strong> - ${t.netProfit} ${report.summary.netProfit} TRY
                        <br><small>Saved: ${new Date(report.timestamp).toLocaleString()}</small>
                    </div>
                    <div>
                        <button onclick="loadReport(${index})" style="background-color: #3498db; margin-right: 5px;">Load</button>
                        <button onclick="deleteReport(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function loadReport(index) {
            const report = savedReports[index];
            if (!report) return;
            
            // Load date
            document.getElementById('report-date').value = report.date;
            
            // Load sales data
            document.getElementById('trendyol-gross').value = report.sales.trendyol.gross;
            document.getElementById('trendyol-discount').value = report.sales.trendyol.discount;
            document.getElementById('yemeksepeti-gross').value = report.sales.yemeksepeti.gross;
            document.getElementById('yemeksepeti-discount').value = report.sales.yemeksepeti.discount;
            document.getElementById('store-cash-gross').value = report.sales.storeCash.gross;
            document.getElementById('store-cash-discount').value = report.sales.storeCash.discount;
            document.getElementById('store-card-gross').value = report.sales.storeCard.gross;
            document.getElementById('store-card-discount').value = report.sales.storeCard.discount;
            if (report.sales.complimentary) {
                document.getElementById('complimentary').value = report.sales.complimentary;
            }
            if (report.sales.complimentaryNotes) {
                document.getElementById('complimentary-notes').value = report.sales.complimentaryNotes;
            }
            
            // Load expenses data
            const expensesTbody = document.getElementById('expenses-tbody');
            expensesTbody.innerHTML = ''; // Clear existing rows
            if (report.expenses && Array.isArray(report.expenses)) {
                report.expenses.forEach(expense => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="input-field expense-category" value="${expense.category}"></td>
                        <td><input type="number" class="input-field expense-amount" value="${expense.amount}" oninput="calculateExpenses()"></td>
                        <td><input type="text" class="input-field expense-notes" value="${expense.notes}"></td>
                        <td><button class="btn" onclick="removeExpenseRow(this)">-</button></td>
                    `;
                    expensesTbody.appendChild(newRow);
                });
            }

            // Load summary data
            if(report.summary.cashInStore) {
                document.getElementById('cash-in-store').value = report.summary.cashInStore;
            }
            if(report.summary.cashWithAbdelhamid) {
                document.getElementById('cash-with-abdelhamid').value = report.summary.cashWithAbdelhamid;
            }
            
            // Recalculate everything
            calculateSales();
            calculateExpenses();
            
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];
            showNotification(t.notifications.reportLoaded, 'success');
        }

        function deleteReport(index) {
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];
            if (confirm(t.confirmDelete)) {
                savedReports.splice(index, 1);
                localStorage.setItem('savedReports', JSON.stringify(savedReports));
                updateSavedReportsList();
                showNotification(t.notifications.reportDeleted, 'success');
            }
        }

        function generateMonthlyReport() {
            const monthSelector = document.getElementById('month-selector');
            const selectedMonth = monthSelector.value;
            if (!selectedMonth) {
                alert('Please select a month.');
                return;
            }

            const [year, month] = selectedMonth.split('-');
            const reportsForMonth = savedReports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate.getFullYear() == year && (reportDate.getMonth() + 1) == month;
            });

            if (reportsForMonth.length === 0) {
                alert('No reports found for the selected month.');
                return;
            }

            let totalGross = 0;
            let totalCommission = 0;
            let totalNetSales = 0;
            let totalExpenses = 0;
            let totalProfit = 0;
            let productSales = {};

            reportsForMonth.forEach(report => {
                totalGross += parseFloat(report.summary.totalGross);
                totalCommission += parseFloat(report.summary.totalCommission);
                totalNetSales += parseFloat(report.summary.totalNet);
                totalExpenses += parseFloat(report.summary.totalExpenses);
                totalProfit += parseFloat(report.summary.netProfit);

                if (report.productSales) {
                    report.productSales.forEach(item => {
                        if (productSales[item.name]) {
                            productSales[item.name].quantity += parseInt(item.quantity);
                            productSales[item.name].total += parseFloat(item.total);
                        } else {
                            productSales[item.name] = {
                                quantity: parseInt(item.quantity),
                                total: parseFloat(item.total)
                            };
                        }
                    });
                }
            });

            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];
            
            document.getElementById('monthly-report-title').textContent = `Report for ${selectedMonth}`;
            const table = document.getElementById('monthly-report-table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>${t.dailySummary}</th>
                        <th>${t.amount}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>${t.totalGrossSales}</td><td>${totalGross.toFixed(2)}</td></tr>
                    <tr><td>${t.totalCommissionPaid}</td><td>${totalCommission.toFixed(2)}</td></tr>
                    <tr><td>${t.totalNetSales}</td><td>${totalNetSales.toFixed(2)}</td></tr>
                    <tr><td>${t.totalExpensesLabel}</td><td>${totalExpenses.toFixed(2)}</td></tr>
                    <tr><td>${t.netProfit}</td><td>${totalProfit.toFixed(2)}</td></tr>
                </tbody>
                <tfoot id="monthly-report-inventory">
                </tfoot>
            `;

            const productSalesTbody = document.getElementById('product-sales-tbody');
            productSalesTbody.innerHTML = '';
            for (const name in productSales) {
                const item = productSales[name];
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.total.toFixed(2)}</td>
                `;
                productSalesTbody.appendChild(newRow);
            }

            document.getElementById('monthly-report-container').style.display = 'block';
            calculateInventoryCost(year, month);
        }


        function addInventoryItem() {
            const tbody = document.getElementById('inventory-tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="input-field inventory-name" placeholder="Item Name"></td>
                <td><input type="number" class="input-field inventory-quantity"></td>
                <td><input type="text" class="input-field inventory-unit" placeholder="e.g., kg, pcs"></td>
                <td><input type="number" class="input-field inventory-cost"></td>
                <td><button class="btn" onclick="removeInventoryItem(this)">-</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeInventoryItem(button) {
            button.closest('tr').remove();
            saveInventory();
        }

        function saveInventory() {
            inventory = Array.from(document.querySelectorAll('#inventory-tbody tr')).map(row => ({
                name: row.querySelector('.inventory-name').value,
                quantity: row.querySelector('.inventory-quantity').value,
                unit: row.querySelector('.inventory-unit').value,
                cost: row.querySelector('.inventory-cost').value
            }));
            localStorage.setItem('inventory', JSON.stringify(inventory));
        }

        function loadInventory() {
            const storedInventory = localStorage.getItem('inventory');
            if (storedInventory) {
                inventory = JSON.parse(storedInventory);
                const tbody = document.getElementById('inventory-tbody');
                tbody.innerHTML = '';
                inventory.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="input-field inventory-name" value="${item.name}" onchange="saveInventory()"></td>
                        <td><input type="number" class="input-field inventory-quantity" value="${item.quantity}" onchange="saveInventory()"></td>
                        <td><input type="text" class="input-field inventory-unit" value="${item.unit}" onchange="saveInventory()"></td>
                        <td><input type="number" class="input-field inventory-cost" value="${item.cost}" onchange="saveInventory()"></td>
                        <td><button class="btn" onclick="removeInventoryItem(this)">-</button></td>
                    `;
                    tbody.appendChild(newRow);
                });
            }
        }

        function calculateInventoryCost(year, month) {
            const t = translations[document.getElementById('language-selector').value];
            let totalCost = 0;
            inventory.forEach(item => {
                totalCost += (parseFloat(item.quantity) || 0) * (parseFloat(item.cost) || 0);
            });

            const inventoryFooter = document.getElementById('monthly-report-inventory');
            inventoryFooter.innerHTML = `
                <tr>
                    <td><strong>${t.inventoryValue}</strong></td>
                    <td><strong>${totalCost.toFixed(2)}</strong></td>
                </tr>
            `;
        }

        function exportSummary(format) {
            const summaryElement = document.getElementById('summary-section');
            html2canvas(summaryElement).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = 'daily_summary.png';
                    link.href = imgData;
                    link.click();
                } else if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    const imgProps= pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save('daily_summary.pdf');
                }
            });
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'reports') {
                generateReportsTab();
            } else if (tabName === 'history') {
                generateHistoryTab();
            } else if (tabName === 'expenses') {
                generateExpensesTab();
            } else if (tabName === 'inventory') {
                generateInventoryTab();
            }
        }

        function generateReportsTab() {
            const reportsContent = document.getElementById('reports-content');
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            let reportsHTML = `
                <div class="section">
                    <h2 data-translate="monthlyReport">${t.monthlyReport}</h2>
                    <div style="margin-bottom: 15px;">
                        <label for="report-type-selector">${"Report Type:"}</label>
                        <select id="report-type-selector" onchange="toggleReportInputs()" style="padding: 8px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="monthly">Monthly</option>
                            <option value="weekly">Weekly</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div id="report-inputs" style="margin-bottom: 15px;">
                        </div>
                    <button class="btn" onclick="generateReportFromTab()" data-translate="generateReport">${t.generateReport}</button>
                    <div id="reports-monthly-report-container" style="display: none;">
                        <h3 id="reports-monthly-report-title"></h3>
                        <table id="reports-monthly-report-table">
                        </table>
                        <button class="btn" onclick="exportReportFromTab()">Export to Excel</button>
                    </div>
                </div>
            `;
            reportsContent.innerHTML = reportsHTML;
            toggleReportInputs();
        }

        function toggleReportInputs() {
            const reportType = document.getElementById('report-type-selector').value;
            const inputsContainer = document.getElementById('report-inputs');
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            let inputsHTML = '';
            if (reportType === 'monthly') {
                inputsHTML = `<label for="reports-month-selector" data-translate="selectMonth">${t.selectMonth}</label>
                              <input type="month" id="reports-month-selector" style="padding: 8px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px;">`;
            } else if (reportType === 'weekly') {
                inputsHTML = `<label for="reports-week-selector">Select Week:</label>
                              <input type="week" id="reports-week-selector" style="padding: 8px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px;">`;
            } else if (reportType === 'custom') {
                inputsHTML = `<label for="reports-start-date">Start Date:</label>
                              <input type="date" id="reports-start-date" style="padding: 8px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px;">
                              <label for="reports-end-date">End Date:</label>
                              <input type="date" id="reports-end-date" style="padding: 8px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px;">`;
            }
            inputsContainer.innerHTML = inputsHTML;
        }

        function exportReportFromTab() {
            const reportTitle = document.getElementById('reports-monthly-report-title').textContent;
            const table = document.getElementById('reports-monthly-report-table');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Summary"});
            XLSX.writeFile(wb, `${reportTitle}.xlsx`);
        }

        function generateReportFromTab() {
            const reportType = document.getElementById('report-type-selector').value;
            let startDate, endDate;
            let reportTitle = '';

            if (reportType === 'monthly') {
                const monthSelector = document.getElementById('reports-month-selector');
                const selectedMonth = monthSelector.value;
                if (!selectedMonth) {
                    alert('Please select a month.');
                    return;
                }
                const [year, month] = selectedMonth.split('-');
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0);
                reportTitle = `Report for ${selectedMonth}`;

            } else if (reportType === 'weekly') {
                const weekSelector = document.getElementById('reports-week-selector');
                const selectedWeek = weekSelector.value;
                if (!selectedWeek) {
                    alert('Please select a week.');
                    return;
                }
                const [year, week] = selectedWeek.split('-W');
                startDate = new Date(year, 0, (week - 1) * 7 + 1);
                endDate = new Date(year, 0, (week - 1) * 7 + 7);
                reportTitle = `Report for week ${week} of ${year}`;

            } else if (reportType === 'custom') {
                const startDateSelector = document.getElementById('reports-start-date');
                const endDateSelector = document.getElementById('reports-end-date');
                startDate = new Date(startDateSelector.value);
                endDate = new Date(endDateSelector.value);

                if (!startDateSelector.value || !endDateSelector.value) {
                    alert('Please select a start and end date.');
                    return;
                }
                reportTitle = `Report from ${startDateSelector.value} to ${endDateSelector.value}`;
            }

            const reportsToProcess = savedReports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate >= startDate && reportDate <= endDate;
            });

            const expensesToProcess = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= startDate && expenseDate <= endDate;
            });

            if (reportsToProcess.length === 0 && expensesToProcess.length === 0) {
                alert('No data found for the selected period.');
                return;
            }

            let income = {
                trendyol: 0,
                yemeksepeti: 0,
                storeCash: 0,
                storeCard: 0,
                total: 0
            };
            let expensesByCategory = {
                rent: 0,
                utilities: 0,
                ingredients: 0,
                salaries: 0,
                advertising: 0,
                other: 0
            };
            let totalExpenses = 0;

            reportsToProcess.forEach(report => {
                income.trendyol += parseFloat(report.sales.trendyol.net) || 0;
                income.yemeksepeti += parseFloat(report.sales.yemeksepeti.net) || 0;
                income.storeCash += parseFloat(report.sales.storeCash.net) || 0;
                income.storeCard += parseFloat(report.sales.storeCard.net) || 0;
            });
            income.total = income.trendyol + income.yemeksepeti + income.storeCash + income.storeCard;

            expensesToProcess.forEach(expense => {
                const amount = parseFloat(expense.amount) || 0;
                totalExpenses += amount;
                if (expensesByCategory[expense.category]) {
                    expensesByCategory[expense.category] += amount;
                } else {
                    expensesByCategory[expense.category] = amount;
                }
            });
            
            let inventoryValue = 0;
            inventory.forEach(item => {
                inventoryValue += (parseFloat(item.quantity) || 0) * (parseFloat(item.cost) || 0);
            });

            const netProfit = income.total - totalExpenses;

            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];
            
            document.getElementById('reports-monthly-report-title').textContent = reportTitle;
            const table = document.getElementById('reports-monthly-report-table');
            let tableHTML = `
                <thead><tr><th colspan="2">Income</th></tr></thead>
                <tbody>
                    <tr><td>Trendyol</td><td>${income.trendyol.toFixed(2)}</td></tr>
                    <tr><td>Yemeksepeti</td><td>${income.yemeksepeti.toFixed(2)}</td></tr>
                    <tr><td>In-Store (Cash)</td><td>${income.storeCash.toFixed(2)}</td></tr>
                    <tr><td>In-Store (Credit Card)</td><td>${income.storeCard.toFixed(2)}</td></tr>
                    <tr class="total-row"><td>Total Income</td><td>${income.total.toFixed(2)}</td></tr>
                </tbody>
                <thead><tr><th colspan="2">Expenses</th></tr></thead>
                <tbody>
                    <tr><td>Rent</td><td>${(expensesByCategory.rent || 0).toFixed(2)}</td></tr>
                    <tr><td>Utilities</td><td>${(expensesByCategory.utilities || 0).toFixed(2)}</td></tr>
                    <tr><td>Ingredients</td><td>${(expensesByCategory.ingredients || 0).toFixed(2)}</td></tr>
                    <tr><td>Salaries</td><td>${(expensesByCategory.salaries || 0).toFixed(2)}</td></tr>
                    <tr><td>Advertising</td><td>${(expensesByCategory.advertising || 0).toFixed(2)}</td></tr>
                    <tr><td>Other</td><td>${(expensesByCategory.other || 0).toFixed(2)}</td></tr>
                    <tr class="total-row"><td>Total Expenses</td><td>${totalExpenses.toFixed(2)}</td></tr>
                </tbody>
                <thead><tr><th colspan="2">Inventory</th></tr></thead>
                <tbody>
                    <tr><td>Inventory Value</td><td>${inventoryValue.toFixed(2)}</td></tr>
                </tbody>
                <thead><tr><th colspan="2">Summary</th></tr></thead>
                <tbody>
                    <tr><td>Total Income</td><td>${income.total.toFixed(2)}</td></tr>
                    <tr><td>Total Expenses</td><td>${totalExpenses.toFixed(2)}</td></tr>
                    <tr class="total-row"><td>Net Profit/Loss</td><td>${netProfit.toFixed(2)}</td></tr>
                </tbody>
            `;
            table.innerHTML = tableHTML;

            document.getElementById('reports-monthly-report-container').style.display = 'block';
        }

        function generateInventoryTab() {
            const inventoryContent = document.getElementById('inventory-content');
            inventoryContent.innerHTML = `
                <div class="section">
                    <h2>Add Inventory Item</h2>
                    <form id="inventory-form" onsubmit="addInventory(event)">
                        <div class="form-grid">
                            <div>
                                <label for="inventory-name">Item Name</label>
                                <input type="text" id="inventory-name" required>
                            </div>
                            <div>
                                <label for="inventory-quantity">Quantity</label>
                                <input type="number" id="inventory-quantity" required>
                            </div>
                            <div>
                                <label for="inventory-unit">Unit</label>
                                <input type="text" id="inventory-unit" placeholder="e.g., kg, pcs" required>
                            </div>
                        </div>
                        <button type="submit" class="btn">Add Item</button>
                    </form>
                </div>
                <div class="section">
                    <h2>Current Inventory</h2>
                    <div id="inventory-table-container"></div>
                </div>
            `;
            renderInventoryTable();
        }

        function generateExpensesTab() {
            const expensesContent = document.getElementById('expenses-content');
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            let expensesHTML = `
                <div class="section">
                    <h2>Upload Bank Statement</h2>
                    <input type="file" id="bank-statement-file" onchange="handleBankStatementUpload(event)">
                </div>
                <div class="section">
                    <h2>Add New Expense</h2>
                    <form id="expense-form" onsubmit="addExpense(event)">
                        <div class="form-grid">
                            <div>
                                <label for="expense-description">Description</label>
                                <input type="text" id="expense-description" required>
                            </div>
                            <div>
                                <label for="expense-amount">Amount</label>
                                <input type="number" id="expense-amount" required>
                            </div>
                            <div>
                                <label for="expense-date">Date</label>
                                <input type="date" id="expense-date" required>
                            </div>
                            <div>
                                <label for="expense-category">Category</label>
                                <select id="expense-category" required>
                                    <option value="rent">Rent</option>
                                    <option value="utilities">Utilities</option>
                                    <option value="ingredients">Ingredients</option>
                                    <option value="salaries">Salaries</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="expense-source">Payment Source</label>
                                <select id="expense-source" required>
                                    <option value="cash">Cash</option>
                                    <option value="bank">Bank</option>
                                </select>
                            </div>
                            <div>
                                <label for="expense-frequency">Frequency</label>
                                <select id="expense-frequency" required>
                                    <option value="one-time">One-time</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn">Add Expense</button>
                    </form>
                </div>
                <div class="section">
                    <h2>All Expenses</h2>
                    <div id="expenses-table-container"></div>
                </div>
            `;
            expensesContent.innerHTML = expensesHTML;
            renderExpensesTable();
        }

        function addExpense(event) {
            event.preventDefault();
            const newExpense = {
                id: Date.now(),
                description: document.getElementById('expense-description').value,
                amount: document.getElementById('expense-amount').value,
                date: document.getElementById('expense-date').value,
                category: document.getElementById('expense-category').value,
                source: document.getElementById('expense-source').value,
                frequency: document.getElementById('expense-frequency').value,
            };
            expenses.push(newExpense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            document.getElementById('expense-form').reset();
            renderExpensesTable();
            showNotification('Expense added successfully!', 'success');
        }

        function renderExpensesTable() {
            const tableContainer = document.getElementById('expenses-table-container');
            if (!tableContainer) return;

            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            let tableHTML = `
                <input type="text" id="expense-search" placeholder="Search..." onkeyup="filterExpenses()" style="width: 100%; padding: 10px; margin-bottom: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortExpenses('description')">Description</th>
                            <th onclick="sortExpenses('amount')">Amount</th>
                            <th onclick="sortExpenses('date')">Date</th>
                            <th onclick="sortExpenses('category')">Category</th>
                            <th onclick="sortExpenses('source')">Source</th>
                            <th onclick="sortExpenses('frequency')">Frequency</th>
                            <th onclick="sortExpenses('recipient')">Recipient</th>
                            <th onclick="sortExpenses('explanation')">Explanation</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expenses.map(expense => `
                            <tr>
                                <td>${expense.description}</td>
                                <td>${expense.amount}</td>
                                <td>${expense.date}</td>
                                <td>
                                    <select class="input-field" onchange="updateExpenseCategory(${expense.id}, this.value)">
                                        <option value="rent" ${expense.category === 'rent' ? 'selected' : ''}>Rent</option>
                                        <option value="utilities" ${expense.category === 'utilities' ? 'selected' : ''}>Utilities</option>
                                        <option value="ingredients" ${expense.category === 'ingredients' ? 'selected' : ''}>Ingredients</option>
                                        <option value="salaries" ${expense.category === 'salaries' ? 'selected' : ''}>Salaries</option>
                                        <option value="sales" ${expense.category === 'sales' ? 'selected' : ''}>Sales</option>
                                        <option value="other" ${expense.category === 'other' ? 'selected' : ''}>Other</option>
                                        <option value="uncategorized" ${expense.category === 'uncategorized' ? 'selected' : ''}>Uncategorized</option>
                                    </select>
                                </td>
                                <td>${expense.source}</td>
                                <td>${expense.frequency}</td>
                                <td>${expense.recipient || ''}</td>
                                <td>${expense.explanation || ''}</td>
                                <td><button class="btn" onclick="deleteExpense(${expense.id})">Delete</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            tableContainer.innerHTML = tableHTML;
        }

        function deleteExpense(id) {
            expenses = expenses.filter(expense => expense.id !== id);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderExpensesTable();
            showNotification('Expense deleted!', 'success');
        }

        function updateExpenseCategory(id, category) {
            const expense = expenses.find(expense => expense.id === id);
            if (expense) {
                expense.category = category;
                localStorage.setItem('expenses', JSON.stringify(expenses));
                showNotification('Category updated!', 'success');
            }
        }

        let sortDirection = {};

        function sortExpenses(key) {
            sortDirection[key] = sortDirection[key] === 'asc' ? 'desc' : 'asc';
            expenses.sort((a, b) => {
                if (a[key] < b[key]) return sortDirection[key] === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return sortDirection[key] === 'asc' ? 1 : -1;
                return 0;
            });
            renderExpensesTable();
        }

        function filterExpenses() {
            const filter = document.getElementById('expense-search').value.toLowerCase();
            const rows = document.querySelectorAll('#expenses-table-container tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        }

        function handleBankStatementUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                // Find the starting row of the transactions
                let startRow = -1;
                for (let i = 0; i < json.length; i++) {
                    if (json[i][0] === 'HESAP NO') {
                        startRow = i + 1;
                        break;
                    }
                }

                if (startRow === -1) {
                    alert('Could not find the start of the transaction data.');
                    return;
                }

                for (let i = startRow; i < json.length; i++) {
                    const row = json[i];
                    const description = row[15] || '';
                    const amount = parseFloat(row[6]);
                    
                    if (description && !isNaN(amount)) {
                        const newExpense = {
                            id: Date.now() + i,
                            description: row[5],
                            amount: amount,
                            date: row[2],
                            category: categorizeExpense(description),
                            source: 'bank',
                            frequency: 'one-time',
                            recipient: row[14],
                            explanation: row[15]
                        };
                        expenses.push(newExpense);
                    }
                }
                localStorage.setItem('expenses', JSON.stringify(expenses));
                renderExpensesTable();
                showNotification('Bank statement uploaded and processed!', 'success');
            };

            reader.readAsArrayBuffer(file);
        }

        function addInventory(event) {
            event.preventDefault();
            const newItem = {
                id: Date.now(),
                name: document.getElementById('inventory-name').value,
                quantity: document.getElementById('inventory-quantity').value,
                unit: document.getElementById('inventory-unit').value,
            };
            inventory.push(newItem);
            localStorage.setItem('inventory', JSON.stringify(inventory));
            document.getElementById('inventory-form').reset();
            renderInventoryTable();
            showNotification('Inventory item added!', 'success');
        }

        function renderInventoryTable() {
            const tableContainer = document.getElementById('inventory-table-container');
            if (!tableContainer) return;

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${inventory.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td><input type="number" value="${item.quantity}" onchange="updateInventoryQuantity(${item.id}, this.value)"></td>
                                <td>${item.unit}</td>
                                <td><button class="btn" onclick="deleteInventoryItem(${item.id})">Delete</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            tableContainer.innerHTML = tableHTML;
        }

        function updateInventoryQuantity(id, quantity) {
            const item = inventory.find(item => item.id === id);
            if (item) {
                item.quantity = quantity;
                localStorage.setItem('inventory', JSON.stringify(inventory));
                showNotification('Quantity updated!', 'success');
            }
        }

        function deleteInventoryItem(id) {
            inventory = inventory.filter(item => item.id !== id);
            localStorage.setItem('inventory', JSON.stringify(inventory));
            renderInventoryTable();
            showNotification('Inventory item deleted!', 'success');
        }

        function categorizeExpense(description) {
            const lowerCaseDescription = description.toLowerCase();
            if (lowerCaseDescription.includes('rent')) {
                return 'rent';
            } else if (lowerCaseDescription.includes('salary')) {
                return 'salaries';
            } else if (lowerCaseDescription.includes('yemeksepeti') || lowerCaseDescription.includes('trendyol')) {
                return 'sales';
            } else {
                return 'uncategorized';
            }
        }

        function generateHistoryTab() {
            const historyContent = document.getElementById('history-content');
            const lang = document.getElementById('language-selector').value;
            const t = translations[lang];

            if (savedReports.length === 0) {
                historyContent.innerHTML = `<p>${t.noSavedReports}</p>`;
                return;
            }

            let historyHTML = `
                <div class="section">
                    <input type="text" id="history-search" placeholder="Search by date..." onkeyup="filterHistory()" style="width: 100%; padding: 10px; margin-bottom: 20px;">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>${t.reportDate}</th>
                                <th>${t.totalNetSales}</th>
                                <th>${t.totalExpensesLabel}</th>
                                <th>${t.netProfit}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${savedReports.map((report, index) => `
                                <tr>
                                    <td>${report.date}</td>
                                    <td>${report.summary.totalNet}</td>
                                    <td>${report.summary.totalExpenses}</td>
                                    <td>${report.summary.netProfit}</td>
                                    <td>
                                        <button class="btn" onclick="loadReport(${index})">Load</button>
                                        <button class="btn" onclick="deleteReport(${index})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            historyContent.innerHTML = historyHTML;
        }

        function filterHistory() {
            const input = document.getElementById('history-search');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('history-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }

        function handleFileUpload(event, platform) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});

                if (platform === 'trendyol') {
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    let totalTutar = 0;
                    let totalKomisyon = 0;
                    let totalIndirim = 0;

                    json.forEach(row => {
                        totalTutar += parseFloat(row['Tutar']) || 0;
                        totalKomisyon += parseFloat(row['Komisyon']) || 0;
                        totalIndirim += parseFloat(row['ƒ∞ndirim']) || 0;
                    });

                    document.getElementById('trendyol-gross').value = totalTutar.toFixed(2);
                    document.getElementById('trendyol-commission').textContent = totalKomisyon.toFixed(2);
                    document.getElementById('trendyol-discount').value = totalIndirim.toFixed(2);
                } else if (platform === 'yemeksepeti') {
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    let subtotalCol = -1;
                    let commissionCol = -1;
                    let discountCol = -1;

                    // Find header row and column indices
                    for (let i = 0; i < json.length; i++) {
                        const row = json[i];
                        if (row.includes('Subtotal') && row.includes('Commission') && row.includes('Discount Funded by Vendor')) {
                            subtotalCol = row.indexOf('Subtotal');
                            commissionCol = row.indexOf('Commission');
                            discountCol = row.indexOf('Discount Funded by Vendor');
                            break;
                        }
                    }

                    if (subtotalCol !== -1) {
                        let totalSubtotal = 0;
                        let totalCommission = 0;
                        let totalDiscount = 0;
                        
                        for (let i = 1; i < json.length; i++) {
                            const row = json[i];
                            if (row[subtotalCol] && !isNaN(parseFloat(row[subtotalCol]))) {
                                totalSubtotal += parseFloat(row[subtotalCol]);
                                totalCommission += parseFloat(row[commissionCol]) || 0;
                                totalDiscount += parseFloat(row[discountCol]) || 0;
                            }
                        }
                        
                        document.getElementById('yemeksepeti-gross').value = totalSubtotal.toFixed(2);
                        document.getElementById('yemeksepeti-commission').textContent = totalCommission.toFixed(2);
                        document.getElementById('yemeksepeti-discount').value = totalDiscount.toFixed(2);
                    } else {
                        alert('Could not find the required columns in the Yemeksepeti file.');
                    }
                } else if (platform === 'in-store') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                        let cashSales = 0;
                        let cardSales = 0;

                        for (let i = 0; i < json.length; i++) {
                            const row = json[i];
                            if (row[0] && row[0].toString().includes('Nakit')) {
                                cashSales = parseFloat(row[2].toString().replace('.', '').replace(',', '.')) || 0;
                            }
                            if (row[0] && row[0].toString().includes('K. Kartƒ±')) {
                                cardSales = parseFloat(row[2].toString().replace('.', '').replace(',', '.')) || 0;
                            }
                        }

                        document.getElementById('store-cash-gross').value = cashSales.toFixed(2);
                        document.getElementById('store-card-gross').value = cardSales.toFixed(2);
                        calculateSales();
                    };
                    reader.readAsArrayBuffer(file);
                }

                calculateSales();
            };

            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>